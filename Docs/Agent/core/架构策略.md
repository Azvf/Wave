# 架构策略：模块化与关注点分离

> 📖 **文档索引**: 返回 [AI 辅助开发规范文档索引](../文档索引.md)

## 核心原则

**彻底摒弃"单文件万能 Prompt"的草莽模式，采用类似操作系统内核的"微内核 + 插件化"架构设计。**

- **微内核策略**: 全局配置文件仅保留"宪法大纲"（语言、核心人设、代码洁癖）
- **插件化策略**: 利用上下文感知能力，通过文件路径物理隔离规则，降低 Prompt 复杂度与冲突概率

## 架构设计

### 微内核（全局配置）

**角色定位**: 全局兜底 (Global Fallback)

**设计原则**:
- **体积控制**: 建议控制在 50 行以内（软性最佳实践）
- **内容限制**: 仅保留全项目通用的指令
- **关注点**: 语言设定、核心人设、代码美学、思考习惯

**为什么建议 < 50 行？**
1. **Token 经济性**: 全局配置内容会被注入到每一次对话的 System Prompt 中，保持极简降低开销
2. **注意力分配**: LLM 的注意力是稀缺资源，避免"中间迷失"现象，将注意力集中在当前上下文
3. **避免规则冲突**: 全局规则权重通常很高，过于细化的全局规则可能干扰特定场景的局部规则

**弹性区间**: 🟢 30-60 行（完美）| 🟡 60-100 行（可接受）| 🔴 > 200 行（反模式）

### 插件化（领域规则）

**角色定位**: 领域特定的原子化规则

**设计原则**:
- **按领域拆分**: 每个规则文件只包含真正必要的内容
- **智能挂载**: 利用上下文感知能力（文件路径、文件类型）自动挂载
- **物理隔离**: 通过文件路径匹配，避免规则冲突

**挂载策略** (Globs Strategy):

| 规则类型 | 职责 | 挂载策略 | 示例 |
|---------|------|---------|------|
| **层级规则** | 物理架构约束 | 按目录匹配 | `src/core/**/*` (禁止依赖上层) |
| **技术栈规则** | 特定框架规范 | 按扩展名匹配 | `**/*.tsx` (UI), `**/*.sql` (DB) |
| **工作流规则** | 强制流程拦截 | 语义触发 | `Agent Trigger: Create component...` |
| **工程规则** | 质量与工具链 | 全局代码文件 | `**/*.ts`, `config/**/*` |

## 规则压缩策略 (Rule Minification)

**核心问题**: 随着项目增长，规则文件会越来越多，导致上下文窗口爆炸和"大海捞针"效应（Lost in the Middle），LLM 可能忽略中间的重要规则。

**解决方案**: 分离"人类阅读版"和"AI 执行版"的规则文件。

### 双版本策略

**人类阅读版** (Human-Readable Version):
- 包含完整的解释性文字（Why）
- 详细的背景说明和使用场景
- 示例代码和最佳实践
- 用于团队学习和文档维护

**AI 执行版** (AI-Executable Version):
- 只保留指令（Action），去除解释性文字（Why）
- 去除 Markdown 渲染标记（如多余的标题层级）
- 去除多余空格和冗余描述
- 压缩为最精简的命令式语句
- 用于实际注入到 AI 的 Context 中

### 规则压缩标准

**去除内容**:
- 解释性段落（"为什么这样做"）
- 背景说明和上下文描述
- 冗长的示例代码（保留最小化示例）
- Markdown 装饰（多余的标题、列表符号）
- 空行和多余空格

**保留内容**:
- 明确的指令和约束（NEVER、MANDATORY、STRICTLY PROHIBIT）
- 关键的技术规范（文件路径、命名规则）
- 最小化的代码模板
- 检查清单项

### 压缩示例

**压缩前**（人类阅读版）:
```markdown
## Domain 层依赖规则

为了保持领域层的纯净性和可测试性，我们禁止在 Domain 层导入任何 UI 框架。

这个规则非常重要，因为：
- Domain 层应该包含纯业务逻辑
- UI 框架会破坏领域层的可移植性
- 测试时需要 Mock UI 框架会增加复杂度

因此，在任何 `lib/features/*/domain/` 目录下的文件中，都严禁导入 `flutter/material.dart` 或 `riverpod`。
```

**压缩后**（AI 执行版）:
```
NEVER import flutter/material.dart or riverpod in lib/features/*/domain/**/*
Domain layer must be pure Dart, no UI framework dependencies.
```

### 维护建议

- **CI/CD 集成**: 建议在 CI/CD 流程中增加规则精简度检查，确保 AI 执行版保持精简
- **版本同步**: 人类阅读版更新时，同步更新 AI 执行版
- **自动化工具**: 考虑开发脚本自动从人类阅读版生成 AI 执行版（去除特定标记的内容）

## 规则文件结构

每个领域规则文件应遵循标准结构：

```markdown
---
description: [动词开头] 简述规则作用
globs: [文件路径匹配模式]
alwaysApply: false
---

# [Domain Name] Architecture

## 1. Persona & Context (角色定位)
*定义该领域的专家身份及核心关注点（Top 3 Priorities）*

## 2. Documentation Dependencies (知识库索引)
*建立文档的 SSOT（单一真理源），防止 AI 编造信息*

## 3. CoT Protocol (思维链协议)
*强制 Agent 在写代码前输出分析块，根据领域风险采用不同力度*

## 4. Critical Prohibitions (防御性禁令)
*明确的 Negative Constraints*

## 5. Implementation Patterns (最佳实践)
*正向引导的代码模板，消除代码风格差异*
```

---

**相关文档**:
- [交互协议](./交互协议.md) - 标准化与特权分级
- [质量控制](./质量控制.md) - 思维链协议与防御性编程
- [治理模式](./治理模式.md) - 通用治理模式
- [维护与注意事项](./维护与注意事项.md) - 规则维护与实践指南

