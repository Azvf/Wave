# 数据同步

**核心原则：双模同步 (Dual Mode) · 冲突解决 (Conflict Resolution) · 分布式锁 (Distributed Lock)**

## SyncService 设计

**职责**:
- 调度所有同步任务
- 管理分布式锁（防止多实例并发）
- 实现双模同步（增量 + 全量）

**实现位置**: `lib/core/sync/sync_service.dart`

**实现模式**:
```dart
@riverpod
class SyncService extends _$SyncService {
  Future<void> scheduleSync() async { /* 调度同步任务 */ }
  Future<void> syncNow() async { /* 立即执行同步 */ }
  Future<void> enqueueRetry(String id) async { /* 加入重试队列 */ }
}
```

## 同步模式

- **增量同步**: 基于 `fetchCursor` 时间游标，只拉取变更
- **全量同步**: 周期性或异常时执行完整三路合并

## 冲突解决策略

**简单字段**: Last-Write-Wins (LWW)
- 谁最后修改，采纳谁的值

**复杂字段**: CRDT 或三路合并 (Three-Way Merge)
- 使用 `ShadowMap` 追踪上次同步状态
- 字段级智能合并

**实现位置**: `lib/core/sync/merge_strategy.dart`

## 分布式锁

**规则**: 防止多实例并发同步导致数据冲突。

**实现**:
- 使用 Isar 的原子操作实现锁
- 设置超时时间，防止死锁

详见: [乐观更新](./乐观更新.md) | [离线优先](./离线优先.md)


