# 乐观更新

**核心原则：零延迟 (Zero Latency) · 立即响应 (Instant Response) · 优雅回滚 (Graceful Rollback)**

> **架构守护**: 乐观更新模式由自定义 Lint 规则检测，确保所有 Mutation 操作都实现乐观更新。

## 设计原则

**规则**: 任何简单的 CRUD 操作（修改标题、添加标签、删除条目），**严禁**等待服务器响应 loading。

**流程**:
1. **Predict (预测)**: 用户触发操作，立即在 UI 上渲染成功后的状态
2. **Render (渲染)**: 界面瞬间变化，不显示 Loading Spinner
3. **Commit (提交)**: 后台静默发送请求
4. **Rollback (回滚)**: 仅在极少数失败情况下，悄悄回滚并提示 Toast

## 实现模式

```dart
@riverpod
class TodoController extends _$TodoController {
  Future<void> toggle(String id) async {
    // 1. 保存旧状态
    final previousState = ref.read(todoListProvider);
    
    // 2. 乐观更新 UI (立即生效)
    ref.read(todoListProvider.notifier).updateLocal(
      id, (item) => item.copyWith(done: !item.done),
    );
    
    try {
      // 3. 提交网络请求
      await ref.read(repositoryProvider).toggleTodo(id);
      ref.read(syncServiceProvider).scheduleSync();
    } catch (e) {
      // 4. 失败回滚
      ref.read(todoListProvider.notifier).state = previousState;
      showToast('Sync failed: ${e.message}');
    }
  }
}
```

## 架构守护

**检查项**:
- [ ] 所有 Mutation 操作都先更新本地状态
- [ ] 网络请求在 try-catch 中执行
- [ ] 失败时回滚到旧状态
- [ ] 错误信息通过 Toast 或 Banner 显示

详见: [离线优先](./离线优先.md) | [数据同步](./数据同步.md)

