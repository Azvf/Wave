# 认证与安全

**核心原则：Token 管理 (Token Management) · 并发控制 (Concurrency Control) · 数据隔离 (Data Isolation)**

## OAuth2/JWT 认证流程

**规则**: 使用 OAuth2 获取 Access Token 和 Refresh Token，JWT 存储在 `flutter_secure_storage`。

**实现位置**: `lib/core/auth/auth_service.dart`

**流程**:
1. 用户登录 -> 获取 Access Token + Refresh Token
2. Access Token 存储在内存（短期）
3. Refresh Token 存储在 Secure Storage（长期）

## Token 刷新机制

**规则**: 使用 Dio 拦截器自动处理 401 并刷新 Token。

**实现模式**:
```dart
class AuthInterceptor extends Interceptor {
  bool _isRefreshing = false;
  final Queue<RequestOptions> _pendingRequests = Queue();
  
  @override
  void onError(DioException err, ErrorInterceptorHandler handler) async {
    if (err.response?.statusCode == 401 && !_isRefreshing) {
      _isRefreshing = true;
      await _refreshToken();
      // 重试所有挂起的请求
      _isRefreshing = false;
    }
  }
}
```

**实现位置**: `lib/core/auth/auth_interceptor.dart`

## 并发请求处理

**规则**: Token 过期时，多个并发请求必须挂起并排队等待 Token 刷新完成。

**策略**:
- 使用队列（Queue）管理挂起的请求
- 第一个 401 触发刷新，其他请求等待
- 刷新成功后批量重试所有挂起请求

## 多账号/多租户数据库隔离

**规则**: Isar 数据库必须按 UserID 隔离，切换账号时不能看到其他用户的缓存数据。

**实现**:
- 使用 `Isar.open(name: 'user_${userId}')` 创建隔离数据库
- 切换账号时关闭旧数据库，打开新数据库
- 或使用单数据库 + `userId` 字段过滤（需确保所有查询都包含 userId）

**实现位置**: `lib/core/storage/database_manager.dart`

## Session 管理

**规则**: 应用启动时检查 Token 有效性，无效则清除本地数据并跳转登录。

**实现**:
- 启动时从 Secure Storage 读取 Refresh Token
- 验证 Token 有效性
- 无效则清除所有本地数据（包括 Isar 数据库）

详见: [技术选型](./技术选型.md) | [监控与日志](./监控与日志.md)

