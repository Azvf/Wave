# 数据库迁移

**核心原则：版本控制 (Version Control) · 向后兼容 (Backward Compatibility) · 回滚策略 (Rollback Strategy)**

## Schema 版本控制

**规则**: Isar 使用 Schema 版本号管理数据库结构变更。

**实现**:
- 每次 Schema 变更时递增版本号
- Isar 自动检测版本差异并触发迁移
- 版本号定义在 `@Collection()` 注解中

**示例**:
```dart
@Collection(version: 2)  // 版本号递增
class Todo {
  Id id = Isar.autoIncrement;
  String title;
  DateTime? deletedAt;  // 新增字段
}
```

## 自动迁移 vs 手动迁移

**自动迁移**: Isar 支持简单的字段添加/删除，自动处理。

**手动迁移**: 涉及逻辑变更（字段拆分、类型转换）时需要手动实现。

**实现位置**: `lib/core/storage/migrations/`

**迁移模式**:
```dart
class Migration1To2 extends Migration {
  @override
  void migrate(Isar isar) {
    // 手动迁移逻辑
    // 例如：字段拆分、数据转换
  }
}
```

## 迁移回滚策略

**规则**: 迁移失败时必须能够回滚到上一版本。

**实现**:
- 迁移前备份数据库
- 迁移失败时恢复备份
- 或使用事务确保原子性

## 数据兼容性处理

**规则**: 新版本 App 必须兼容旧版本数据库。

**策略**:
- 新增字段使用可选类型（`?`）或默认值
- 删除字段时保留迁移逻辑，标记为废弃
- 类型变更时提供转换函数

详见: [构建工作流](./构建工作流.md) | [环境配置](./环境配置.md)

