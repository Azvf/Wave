# 测试指南

**核心原则：测试金字塔 (Testing Pyramid) · 覆盖率 (Coverage) · 快速反馈 (Fast Feedback)**

> **架构守护**: 所有策略类必须有单元测试，覆盖率要求 90%+。

## 测试金字塔

### Unit Tests (单元测试)
- **目标**: Core/Domain 层纯 Dart 逻辑
- **工具**: `flutter_test` + `mocktail`
- **覆盖率**: 90%+
- **特点**: 快速、隔离、无依赖

### Widget Tests (组件测试)
- **目标**: Presentation 层交互逻辑
- **工具**: `flutter_test` + `golden_toolkit`
- **重点**: Riverpod Provider 测试、交互行为
- **特点**: 使用 Golden Tests 进行视觉回归

### Integration Tests (集成测试)
- **目标**: 关键业务链路（离线写入 -> 同步 -> 恢复）
- **工具**: `integration_test`
- **特点**: 端到端验证，覆盖真实场景

## Riverpod Provider 测试

**规则**: 使用 `ProviderScope` 的 Override 进行测试。

```dart
testWidgets('TodoList displays items', (tester) async {
  await tester.pumpWidget(
    ProviderScope(
      overrides: [
        todoRepositoryProvider.overrideWithValue(MockTodoRepository()),
      ],
      child: MaterialApp(home: TodoListPage()),
    ),
  );
  // 测试逻辑
});
```

## Isar Mock 策略

**规则**: 使用内存版 Isar 进行测试，避免依赖真实数据库。

**实现**: 在测试中创建临时 Isar 实例，测试结束后清理。

```dart
late Isar isar;

setUp(() async {
  isar = await Isar.open([TodoSchema], directory: '/tmp/test');
});

tearDown(() async {
  await isar.close(deleteFromDisk: true);
});
```

## Golden Tests (视觉回归)

**规则**: 桌面端 UI 对布局敏感，使用 Golden Tests 确保响应式布局不崩坏。

**工具**: `golden_toolkit`

**使用场景**: 关键组件在不同分辨率下的布局验证。

## Repository Mocking

**策略**: 使用 `mocktail` 模拟 Repository 接口，避免依赖真实数据源。

**实现位置**: `test/mocks/` 目录

详见: [构建工作流](./构建工作流.md) | [架构守护](./架构守护.md)

