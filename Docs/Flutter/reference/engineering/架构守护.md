# 架构守护

**核心原则：工具强制 (Tool Enforcement) · 违规即失败 (Fail on Violation)**

> **架构守护**: 所有架构规则由工具强制执行，违规即构建失败。

## 架构守护配置

**实现位置**: `analysis_options.yaml`

```yaml
include: package:very_good_analysis/analysis_options.yaml

analyzer:
  plugins:
    - custom_lint
  errors:
    invalid_annotation_target: error
    avoid_relative_lib_imports: error

linter:
  rules:
    prefer_single_quotes: true
    avoid_print: true
    always_declare_return_types: true
```

## 禁令分级策略

**核心原则**: 不要用 Prompt 去做 Lint 能做的事。Prompt 应该专注于生成，Lint 专注于拒绝。

### Lint 级别 vs Prompt 级别

**Lint 级别**（应由自定义 Lint 规则强制执行）:
- **物理架构约束**: Domain 层禁止导入 UI 框架、依赖方向检查、循环依赖检测
- **类型安全约束**: 强制使用类型安全的 API、禁止动态类型滥用
- **代码结构约束**: 文件组织规则、命名规范

**Prompt 级别**（保留在 Prompt 规则中）:
- **代码风格**: 命名偏好、代码格式建议
- **业务规则**: 特定业务逻辑的实现模式
- **实现模式**: 最佳实践和代码模板

### Prompt → Lint 转换清单

以下禁令应转换为 Lint 规则（物理上禁止）：

| 禁令类型 | 当前状态 | 目标状态 | 优先级 |
|---------|---------|---------|--------|
| Domain 层禁止导入 Flutter | ✅ Lint 规则 | - | 已完成 |
| Domain 层禁止导入 Riverpod | ✅ Lint 规则 | - | 已完成 |
| 依赖方向检查（Presentation → Domain → Data） | ✅ Lint 规则 | - | 已完成 |
| API 客户端必须从 OpenAPI 生成 | ⚠️ Prompt | Lint 规则 | P1 |
| 乐观更新检测 | ⚠️ Prompt | Lint 规则 | P2 |

### 转换原则

1. **可静态分析**: 如果违规可以通过静态分析（AST、依赖图）检测，应该转换为 Lint 规则
2. **物理禁止**: Lint 规则可以在编译时物理上禁止违规代码，比 Prompt 更可靠
3. **成本效益**: 转换成本低、收益高的规则优先转换
4. **误报率**: 如果规则容易误报，可能需要保留在 Prompt 中或使用更智能的检测逻辑

### 实施建议

- **渐进式转换**: 根据优先级逐步将 Prompt 禁令转换为 Lint 规则
- **混合策略**: 关键规则使用 Lint，辅助规则使用 Prompt
- **文档同步**: Prompt 规则转换为 Lint 后，同步更新文档和 Prompt 文件

## 自定义 Lint 规则

**实现位置**: `tool/custom_lint/` (自定义 Lint 插件)

**检查项**:
- Domain 层禁止导入 Flutter 包
- 乐观更新检测（Mutation 方法必须实现乐观更新）
- 硬编码检测（禁止魔法数字、颜色值等）
- **API 契约检查**: 确保使用 OpenAPI 生成的客户端，禁止手动定义 API 接口（除非特殊情况，需添加注释说明）

## 依赖检查

**规则**: 确保分层架构不被穿透

- `domain/` 层不依赖 `flutter` 或 `riverpod`
- `data/` 层不依赖 `presentation/`
- 禁止循环依赖
- **API 客户端检查**: 确保 API 客户端从 OpenAPI 规范生成，禁止手动编写（Retrofit 仅作为遗留接口的后备）

**工具**: 自定义 `analyzer` 插件

详见: [构建工作流](./构建工作流.md) | [CI-CD](./CI-CD.md)


