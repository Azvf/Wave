# ADR-002: 为什么选择 Isar 而不是 SQLite

## 状态

已采用

## 背景

Flutter 桌面应用需要本地数据库支持，用于离线优先架构。数据库需要：
- 高性能读写
- 强类型支持
- 跨平台兼容（Windows、macOS、Linux）
- 支持复杂查询
- 良好的开发体验

## 考虑的选项

### 1. Isar

**优点**:
- 极速性能，基于 IndexedDB 和 LevelDB
- 强类型支持，编译时类型检查
- 跨平台友好，支持所有 Flutter 平台
- 优秀的查询 API，支持复杂查询和过滤
- 内置索引和关联支持
- 良好的开发体验，代码生成支持

**缺点**:
- 生态系统相对较小（相比 SQLite）
- 学习曲线（需要理解 Isar 的查询语法）
- 文件大小相对较大

### 2. SQLite (sqflite)

**优点**:
- 成熟稳定，广泛使用
- SQL 标准语法，团队熟悉度高
- 丰富的生态系统和社区支持
- 文件大小小

**缺点**:
- 桌面端支持需要额外配置（sqflite_common_ffi）
- 性能相对 Isar 较慢
- 弱类型，运行时错误风险
- SQL 字符串查询，缺少编译时检查
- 代码生成支持较弱

### 3. Hive

**优点**:
- 轻量级，零依赖
- 简单易用
- 性能良好
- 支持所有平台

**缺点**:
- 缺少关系查询支持
- 复杂查询能力有限
- 类型安全较弱（需要手动类型转换）
- 不适合复杂的数据模型

## 决策

选择 **Isar** 作为本地数据库方案。

## 理由

1. **极速性能**: Isar 的性能优于 SQLite，特别是在复杂查询和大数据量场景下。这对于桌面应用的响应速度至关重要。

2. **强类型支持**: Isar 提供编译时类型检查，可以避免 SQL 字符串错误和类型不匹配的运行时错误。

3. **跨平台友好**: Isar 原生支持所有 Flutter 平台（包括桌面端），无需额外的 FFI 配置。

4. **优秀的查询 API**: Isar 的查询 API 既强大又类型安全，支持复杂查询而不需要编写 SQL 字符串。

5. **开发体验**: Isar 的代码生成和类型安全特性提供了更好的开发体验，减少调试时间。

6. **离线优先架构**: Isar 的性能和特性完美契合我们的离线优先架构需求（参考 [离线优先](../principles/data/离线优先.md)）。

## 后果

### 正面影响

- 高性能数据库操作，提升应用响应速度
- 类型安全，减少运行时错误
- 更好的开发体验和代码质量
- 跨平台兼容性，无需额外配置

### 负面影响和风险

- Isar 的生态系统相对较小，可能缺少某些第三方库支持
- 团队需要学习 Isar 的查询语法和最佳实践
- 文件大小相对 SQLite 较大，但可以接受

### 注意事项

- 确保团队了解 Isar 的数据模型定义和查询语法
- 建立 Isar Schema 的组织规范（参考 [代码组织](../principles/framework/代码组织.md)）
- 注意数据库迁移策略（参考 [数据库迁移](../reference/engineering/数据库迁移.md)）
- 考虑未来数据量增长时的性能优化

---

**相关文档**:
- [技术选型](../principles/framework/技术选型.md)
- [离线优先](../principles/data/离线优先.md)
- [数据库迁移](../reference/engineering/数据库迁移.md)

